<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Tilawah Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #FCFAF7;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.4s ease-out forwards;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-active {
            color: #2D5A27 !important;
        }

        /* Sembunyikan scrollbar */
        ::-webkit-scrollbar {
            width: 0px;
        }
    </style>
</head>
<body class="text-gray-900">

    <div class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-[#FCFAF7]">
        
        <!-- HEADER -->
        <header id="appHeader" class="pt-8 pb-4 px-6 flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-bold text-[#2D2D2D]">Assalamuâ€™alaikum</h1>
                <p id="userDisplayName" class="text-sm text-[#7A7A7A] mt-1 italic">Memuat profil...</p>
            </div>
            <button onclick="openProfileModal()" class="p-2 rounded-full bg-white shadow-sm border border-gray-100 text-[#2D5A27]">
                <i data-lucide="user" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- VIEW: BERANDA -->
        <main id="view-home" class="view-section active pb-32">
            <div class="px-6 mt-4">
                <div class="bg-[#2D5A27] rounded-3xl p-6 text-white relative overflow-hidden shadow-xl shadow-green-900/10">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-2 bg-white/20 w-fit px-3 py-1 rounded-full backdrop-blur-sm">
                            <i data-lucide="heart" class="w-3 h-3 fill-current"></i>
                            <span id="statTextHome" class="text-[10px] font-medium tracking-wide uppercase">Memuat...</span>
                        </div>
                        <h2 class="text-3xl font-bold">Terus Istiqomah</h2>
                        <p class="text-sm opacity-80 mt-2">"Hati akan tenang dengan mengingat Allah."</p>
                    </div>
                    <i data-lucide="book-open" class="absolute -right-6 -top-6 w-40 h-40 opacity-10"></i>
                </div>
            </div>

            <div class="px-6 mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800">Aktivitas Terakhir</h3>
                    <button onclick="changeView('progress')" class="text-[#2D5A27] text-xs font-semibold">Lihat Semua</button>
                </div>
                <div id="recentLogs" class="space-y-3">
                    <div class="text-center py-10 bg-white rounded-2xl border border-dashed border-gray-200 text-gray-400 text-sm">
                        Belum ada catatan tilawah ðŸŒ¿
                    </div>
                </div>
            </div>
        </main>

        <!-- VIEW: PROGRES -->
        <main id="view-progress" class="view-section pb-32">
            <div class="p-6">
                <h2 class="text-xl font-bold">Perjalanan Anda</h2>
                <p class="text-sm text-gray-500">Statistik tilawah Anda di server.</p>
            </div>
            <div class="px-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm text-center">
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Total Menit</p>
                        <p id="totalMinutes" class="text-2xl font-bold text-[#2D5A27]">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm text-center">
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Sesi Selesai</p>
                        <p id="totalSessions" class="text-2xl font-bold text-[#C5A059]">0</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- VIEW: BADGES -->
        <main id="view-badges" class="view-section pb-32">
            <div class="p-6 text-center">
                <h2 class="text-xl font-bold">Lencana Pencapaian</h2>
                <p class="text-sm text-gray-500">Kumpulkan apresiasi dari tilawahmu</p>
            </div>
            <div id="badgeGrid" class="px-6 grid grid-cols-2 gap-4">
                <!-- Badges dynamically rendered -->
            </div>
        </main>

        <!-- VIEW: INPUT -->
        <main id="view-input" class="view-section pb-32">
            <div class="p-6 flex items-center gap-4">
                <button onclick="changeView('home')" class="p-2 text-gray-400"><i data-lucide="chevron-left"></i></button>
                <h2 class="text-xl font-bold">Catat Tilawah</h2>
            </div>
            <div class="px-6 space-y-6">
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-500">Pilih Surah</label>
                    <select id="inputSurah" class="w-full p-4 bg-white border border-gray-100 rounded-2xl text-md outline-none focus:ring-2 focus:ring-[#2D5A27]">
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-500">Ayat Awal</label>
                        <input id="inputStart" type="number" placeholder="1" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-500">Ayat Akhir</label>
                        <input id="inputEnd" type="number" placeholder="10" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium text-gray-500">Waktu Tilawah</label>
                    <input id="inputDateTime" type="datetime-local" class="w-full p-4 bg-white border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#2D5A27]">
                </div>

                <div class="pt-4">
                    <button id="btnSave" onclick="handleSave()" class="w-full bg-[#2D5A27] text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-all">
                        Simpan Sesi
                    </button>
                </div>
            </div>
        </main>

        <!-- VIEW: GURU (PENGELOLA) -->
        <main id="view-teacher" class="view-section pb-32">
            <!-- Login Admin Overlay -->
            <div id="adminLoginSection" class="p-8 text-center flex flex-col items-center justify-center min-h-[60vh]">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="lock" class="text-gray-400"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Akses Terbatas</h2>
                <p class="text-sm text-gray-500 mb-6">Masukkan kode akses untuk membuka Panel Pengelola.</p>
                <input id="adminPinInput" type="password" placeholder="Kode PIN Admin" class="w-full max-w-[200px] text-center p-4 bg-white border border-gray-200 rounded-2xl outline-none focus:ring-2 focus:ring-[#2D5A27]">
                <button onclick="verifyAdmin()" class="mt-4 w-full max-w-[200px] py-3 bg-[#2D5A27] text-white font-bold rounded-xl shadow-md">Masuk</button>
            </div>

            <!-- Admin Content -->
            <div id="adminContent" class="hidden">
                <div class="p-6 flex justify-between items-end">
                    <div>
                        <h2 class="text-xl font-bold">Panel Pengelola</h2>
                        <p class="text-sm text-gray-500">Monitoring & Data Ekspor.</p>
                    </div>
                    <button id="btnDownloadCSV" onclick="downloadFullReport()" class="p-2 bg-[#2D5A27] text-white rounded-lg flex items-center gap-1 text-xs font-bold disabled:opacity-50">
                        <i data-lucide="download" class="w-3 h-3"></i> <span id="downloadBtnText">Unduh Laporan</span>
                    </button>
                </div>
                <div id="studentList" class="px-6 space-y-4">
                    <p class="text-center text-gray-400 py-10 text-sm">Mencari data murid...</p>
                </div>
            </div>
        </main>

        <!-- NAVIGATION -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-100 px-6 py-4 flex justify-between items-center z-50">
            <button onclick="changeView('home')" id="nav-home" class="flex flex-col items-center nav-active">
                <i data-lucide="book-open" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1 font-semibold">Beranda</span>
            </button>
            <button onclick="changeView('progress')" id="nav-progress" class="flex flex-col items-center text-gray-400">
                <i data-lucide="trending-up" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1 font-semibold">Progres</span>
            </button>
            <div class="relative -mt-12">
                <button onclick="changeView('input')" class="bg-[#2D5A27] text-white p-4 rounded-full shadow-lg border-4 border-[#FCFAF7] active:scale-90 transition-transform">
                    <i data-lucide="plus" class="w-6 h-6"></i>
                </button>
            </div>
            <button onclick="changeView('teacher')" id="nav-teacher" class="flex flex-col items-center text-gray-400">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1 font-semibold">Pengelola</span>
            </button>
            <button onclick="changeView('badges')" id="nav-badges" class="flex flex-col items-center text-gray-400">
                <i data-lucide="award" class="w-5 h-5"></i>
                <span class="text-[10px] mt-1 font-semibold">Badge</span>
            </button>
        </nav>

        <!-- IDENTITY MODAL (Login/Update Profile) -->
        <div id="modalProfile" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-md p-6">
            <div class="bg-white rounded-3xl p-8 shadow-2xl w-full max-w-xs scale-95 opacity-0 transition-all duration-300" id="modalProfileContent">
                <div class="text-4xl mb-4 text-center">ðŸ‘¤</div>
                <h3 class="text-xl font-bold text-center text-gray-900">Identitas Mahasiswa</h3>
                <p class="text-gray-500 mt-2 text-center text-sm italic">Nama & NIM diperlukan untuk laporan pengelola.</p>
                
                <div class="mt-6 space-y-4">
                    <input id="userNameInput" type="text" placeholder="Nama Lengkap" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#2D5A27]">
                    <input id="userNimInput" type="text" placeholder="Masukkan NIM" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-[#2D5A27]">
                </div>

                <button onclick="saveUserProfile()" class="mt-6 w-full py-4 bg-[#2D5A27] text-white font-bold rounded-2xl shadow-lg">Simpan</button>
            </div>
        </div>

        <!-- SUCCESS MODAL -->
        <div id="modalSuccess" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm p-6">
            <div class="bg-white rounded-3xl p-8 text-center shadow-2xl w-full max-w-xs scale-90 opacity-0 transition-all duration-300" id="modalContent">
                <div class="text-5xl mb-4">ðŸŒ¿</div>
                <h3 class="text-2xl font-bold text-gray-900">MasyaAllah!</h3>
                <p class="text-gray-500 mt-2">Sesi tilawah Anda berhasil dicatat dan tersinkronisasi.</p>
                <button onclick="closeModal()" class="mt-6 w-full py-3 bg-[#EBF0EE] text-[#2D5A27] font-bold rounded-xl">Tutup</button>
            </div>
        </div>

        <!-- DELETE CONFIRMATION -->
        <div id="modalDelete" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm p-6">
            <div class="bg-white rounded-3xl p-8 text-center shadow-2xl w-full max-w-xs">
                <h3 class="text-xl font-bold text-gray-900">Hapus Catatan?</h3>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeDeleteModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl">Batal</button>
                    <button id="confirmDeleteBtn" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl">Hapus</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const surahs = ["Al-Fatihah","Al-Baqarah","Ali 'Imran","An-Nisa'","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Taubah","Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra'","Al-Kahf","Maryam","Taha","Al-Anbiya'","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Asy-Syu'ara'","An-Naml","Al-Qasas","Al-'Ankabut","Ar-Rum","Luqman","As-Sajdah","Al-Ahzab","Saba'","Fatir","Yasin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Asy-Syura","Az-Zukhruf","Ad-Dukhan","Al-Jasiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Az-Zariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadilah","Al-Hasyr","Al-Mumtahanah","As-Saff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij","Nuh","Al-Jinn","Al-Muzzammil","Al-Muddassir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba'","An-Nazi'at","'Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Insyiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghasyiyah","Al-Fajr","Al-Balad","Asy-Syams","Al-Lail","Ad-Duha","Asy-Syarh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-'Adiyat","Al-Qari'ah","At-Takasur","Al-'Asr","Al-Humazah","Al-Fil","Quraisy","Al-Ma'un","Al-Kausar","Al-Kafirun","An-Nasr","Al-Lahab","Al-Ikhlas","Al-Falaq","An-Nas"];

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "", projectId: "demo" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'quran-monitor-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let userData = null;
        let deleteTargetId = null;
        let studentDataList = [];
        let isAdmin = false;

        // --- AUTH FLOW ---
        const startApp = async () => {
            try {
                if (initialAuthToken) await auth.signInWithCustomToken(initialAuthToken);
                else await auth.signInAnonymously();

                auth.onAuthStateChanged(user => {
                    currentUser = user;
                    if (user) {
                        lucide.createIcons();
                        populateSurahs();
                        setDefaultDateTime();
                        fetchUserProfile();
                        listenToLogs();
                        listenToStudents();
                    }
                });
            } catch (e) { console.error("Auth Fail:", e); }
        };

        // --- ADMIN VERIFICATION ---
        function verifyAdmin() {
            const pin = document.getElementById('adminPinInput').value;
            if (pin === "1234") {
                isAdmin = true;
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminContent').classList.remove('hidden');
                document.getElementById('adminContent').style.display = 'block';
                renderStudentList();
                lucide.createIcons();
            } else {
                alert("Kode PIN salah.");
            }
        }

        // --- IDENTITY MANAGEMENT ---
        async function fetchUserProfile() {
            if (!currentUser) return;
            const profilePath = `artifacts/${appId}/public/data/student_progress/${currentUser.uid}`;
            db.doc(profilePath).onSnapshot(doc => {
                if (doc.exists) {
                    userData = doc.data();
                    const displayName = `${userData.name} (${userData.nim || 'NIM Kosong'})`;
                    document.getElementById('userDisplayName').innerText = `Murid: ${displayName}`;
                } else {
                    document.getElementById('userDisplayName').innerText = `Profil belum diset`;
                    setTimeout(openProfileModal, 1000);
                }
            });
        }

        function openProfileModal() {
            const m = document.getElementById('modalProfile');
            const c = document.getElementById('modalProfileContent');
            m.classList.remove('hidden');
            setTimeout(() => c.classList.remove('scale-95', 'opacity-0'), 10);
            if (userData) {
                document.getElementById('userNameInput').value = userData.name || "";
                document.getElementById('userNimInput').value = userData.nim || "";
            }
        }

        async function saveUserProfile() {
            const name = document.getElementById('userNameInput').value;
            const nim = document.getElementById('userNimInput').value;
            if (!name || !nim || !currentUser) {
                alert("Mohon lengkapi Nama dan NIM.");
                return;
            }

            const profilePath = `artifacts/${appId}/public/data/student_progress/${currentUser.uid}`;
            await db.doc(profilePath).set({
                name: name,
                nim: nim,
                lastActive: "Baru saja aktif",
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            closeProfileModal();
        }

        function closeProfileModal() {
            const m = document.getElementById('modalProfile');
            const c = document.getElementById('modalProfileContent');
            c.classList.add('scale-95', 'opacity-0');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        // --- UI UTILITIES ---
        function populateSurahs() {
            const select = document.getElementById('inputSurah');
            if (select) select.innerHTML = surahs.map((name, i) => `<option value="${name}">${i+1}. ${name}</option>`).join('');
        }

        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('inputDateTime').value = now.toISOString().slice(0, 16);
        }

        function changeView(viewId) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            const target = document.getElementById('view-' + viewId);
            if (target) target.classList.add('active');
            
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.add('text-gray-400');
                b.classList.remove('nav-active');
            });
            
            const btn = document.getElementById('nav-' + viewId);
            if (btn) {
                btn.classList.add('nav-active');
                btn.classList.remove('text-gray-400');
            }
            document.getElementById('appHeader').style.display = (viewId === 'home') ? 'flex' : 'none';
            if(viewId === 'badges' || viewId === 'teacher') lucide.createIcons();
        }

        // --- BADGE LOGIC ---
        const ALL_BADGES = [
            { id: 'newbie', name: 'Pemula Sabar', icon: 'ðŸŒ±', req: logs => logs.length >= 1 },
            { id: 'consistent_7', name: '7 Hari Beruntun', icon: 'ðŸ”¥', req: logs => logs.length >= 7 },
            { id: 'morning_warrior', name: 'Pejuang Subuh', icon: 'â˜€ï¸', req: logs => logs.some(l => {
                if(!l.manualTimestamp) return false;
                const h = new Date(l.manualTimestamp).getHours();
                return h >= 4 && h <= 6;
            })},
            { id: 'mulk_lover', name: 'Pecinta Al-Mulk', icon: 'âœ¨', req: logs => logs.filter(l => l.surah === 'Al-Mulk').length >= 3 },
            { id: 'khatam_1', name: 'Khatam Pertama', icon: 'ðŸ‘‘', req: logs => logs.length >= 604 },
            { id: 'night_owl', name: 'Pejuang Malam', icon: 'ðŸŒ™', req: logs => logs.some(l => {
                if(!l.manualTimestamp) return false;
                const h = new Date(l.manualTimestamp).getHours();
                return h >= 22 || h <= 3;
            })}
        ];

        function getUnlockedBadges(logs) {
            return ALL_BADGES.filter(b => b.req(logs)).map(b => b.name);
        }

        function renderBadgeGrid(logs) {
            const grid = document.getElementById('badgeGrid');
            if(!grid) return;
            grid.innerHTML = ALL_BADGES.map(b => {
                const unlocked = b.req(logs);
                return `
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex flex-col items-center transition-all ${unlocked ? '' : 'opacity-40 grayscale'}">
                    <div class="text-4xl mb-3">${b.icon}</div>
                    <p class="text-[11px] font-bold text-gray-800">${b.name}</p>
                    <p class="text-[9px] mt-1 font-bold ${unlocked ? 'text-green-500' : 'text-gray-400'} uppercase">
                        ${unlocked ? 'Terbuka' : 'Terkunci'}
                    </p>
                </div>
                `;
            }).join('');
        }

        // --- DATA SYNC ---
        function listenToLogs() {
            if (!currentUser) return;
            const path = `artifacts/${appId}/users/${currentUser.uid}/tilawah_logs`;
            db.collection(path).onSnapshot(snap => {
                const logs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                logs.sort((a, b) => {
                    const dateA = a.manualTimestamp ? new Date(a.manualTimestamp) : (a.timestamp?.toDate() || 0);
                    const dateB = b.manualTimestamp ? new Date(b.manualTimestamp) : (b.timestamp?.toDate() || 0);
                    return dateB - dateA;
                });
                renderHome(logs);
                renderProgress(logs);
                renderBadgeGrid(logs);
            }, err => console.error("Firestore Error:", err));
        }

        function listenToStudents() {
            if (!currentUser) return;
            const path = `artifacts/${appId}/public/data/student_progress`;
            db.collection(path).onSnapshot(snap => {
                studentDataList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (isAdmin) renderStudentList();
            });
        }

        async function handleSave() {
            if (!currentUser) return;
            const surah = document.getElementById('inputSurah').value;
            const start = document.getElementById('inputStart').value;
            const end = document.getElementById('inputEnd').value;
            const manualTime = document.getElementById('inputDateTime').value;
            const btn = document.getElementById('btnSave');

            if (!start || !end || !manualTime) return;

            btn.disabled = true;
            btn.innerText = "Menyimpan...";

            try {
                // Catat Log
                const logPath = `artifacts/${appId}/users/${currentUser.uid}/tilawah_logs`;
                await db.collection(logPath).add({
                    surah, start, end,
                    duration: 15,
                    manualTimestamp: manualTime,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update Progress Publik
                const profilePath = `artifacts/${appId}/public/data/student_progress/${currentUser.uid}`;
                await db.doc(profilePath).set({
                    name: userData ? userData.name : "Tanpa Nama",
                    nim: userData ? userData.nim : "Kosong",
                    lastActive: new Date().toLocaleTimeString('id-ID'),
                    lastSurah: surah,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                showModal();
                document.getElementById('inputStart').value = '';
                document.getElementById('inputEnd').value = '';
                setDefaultDateTime();
            } catch (e) { console.error("Save Error:", e); }
            finally { 
                btn.disabled = false; 
                btn.innerText = "Simpan Sesi"; 
            }
        }

        // --- DOWNLOAD FULL REPORT ---
        async function downloadFullReport() {
            if (studentDataList.length === 0) return;
            const btn = document.getElementById('btnDownloadCSV');
            const btnText = document.getElementById('downloadBtnText');
            btn.disabled = true;
            btnText.innerText = "Mengekspor...";

            try {
                let csvContent = "\ufeff"; 
                csvContent += "NIM,Nama Murid,Waktu Tilawah,Surah,Ayat Awal,Ayat Akhir,Durasi(Min),Pencapaian/Badges\n";
                
                for (const student of studentDataList) {
                    const logsPath = `artifacts/${appId}/users/${student.id}/tilawah_logs`;
                    const snap = await db.collection(logsPath).get();
                    const logs = snap.docs.map(doc => doc.data());
                    const unlockedBadges = getUnlockedBadges(logs).join(" | ");

                    logs.sort((a, b) => {
                        const dateA = a.manualTimestamp ? new Date(a.manualTimestamp) : (a.timestamp?.toDate() || 0);
                        const dateB = b.manualTimestamp ? new Date(b.manualTimestamp) : (b.timestamp?.toDate() || 0);
                        return dateA - dateB;
                    });

                    if (logs.length > 0) {
                        logs.forEach(l => {
                            const row = `"${student.nim || '-'}","${student.name}","${l.manualTimestamp || '-'}","${l.surah}","${l.start}","${l.end}","${l.duration}","${unlockedBadges}"`;
                            csvContent += row + "\n";
                        });
                    } else {
                        const row = `"${student.nim || '-'}","${student.name}","Belum mengaji","-","-","-","0","-"`;
                        csvContent += row + "\n";
                    }
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Laporan_Tilawah_Lengkap_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error("Export Error:", err);
                alert("Gagal mengunduh laporan.");
            } finally {
                btn.disabled = false;
                btnText.innerText = "Unduh Laporan";
            }
        }

        // --- RENDERING ---
        function renderStudentList() {
            const list = document.getElementById('studentList');
            if (!list) return;
            if (studentDataList.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-400 py-10 text-sm">Belum ada murid aktif.</p>`;
                return;
            }
            list.innerHTML = studentDataList.map(s => `
                <div class="bg-white p-4 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-[#EBF0EE] flex items-center justify-center font-bold text-[#2D5A27]">
                            ${s.name ? s.name[0] : 'S'}
                        </div>
                        <div>
                            <p class="font-semibold text-sm">${s.name || 'Murid'}</p>
                            <p class="text-[10px] text-gray-400 font-mono">NIM: ${s.nim || '-'}</p>
                            <p class="text-[10px] text-gray-400">Aktif: ${s.lastActive || '-'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                         <p class="text-[10px] font-bold text-[#C5A059] uppercase">${s.lastSurah || 'Mulai'}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderHome(logs) {
            const statText = document.getElementById('statTextHome');
            if (statText) statText.innerText = `${logs.length} Sesi Terlaksana`;
            const container = document.getElementById('recentLogs');
            if (!container) return;
            if (logs.length === 0) {
                container.innerHTML = `<div class="text-center py-10 bg-white rounded-2xl border border-dashed border-gray-200 text-gray-400 text-sm">Belum ada catatan ðŸŒ¿</div>`;
                return;
            }
            container.innerHTML = logs.slice(0, 5).map(log => {
                const date = log.manualTimestamp ? new Date(log.manualTimestamp) : (log.timestamp?.toDate() || new Date());
                const dateString = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                return `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <p class="font-bold text-gray-800">Surah ${log.surah}</p>
                            <span class="text-[10px] bg-gray-50 px-2 py-0.5 rounded text-gray-500">Ayat ${log.start}-${log.end}</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">${dateString}</p>
                    </div>
                    <button onclick="openDeleteModal('${log.id}')" class="p-2 text-gray-300">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function renderProgress(logs) {
            if(document.getElementById('totalSessions')) document.getElementById('totalSessions').innerText = logs.length;
            if(document.getElementById('totalMinutes')) document.getElementById('totalMinutes').innerText = logs.length * 15;
        }

        function openDeleteModal(id) {
            deleteTargetId = id;
            document.getElementById('modalDelete').classList.remove('hidden');
            document.getElementById('confirmDeleteBtn').onclick = deleteLog;
        }
        function closeDeleteModal() { document.getElementById('modalDelete').classList.add('hidden'); }
        async function deleteLog() {
            if (!currentUser || !deleteTargetId) return;
            await db.collection(`artifacts/${appId}/users/${currentUser.uid}/tilawah_logs`).doc(deleteTargetId).delete();
            closeDeleteModal();
        }

        function showModal() {
            const m = document.getElementById('modalSuccess');
            const c = document.getElementById('modalContent');
            m.classList.remove('hidden');
            setTimeout(() => c.classList.remove('scale-90', 'opacity-0'), 10);
        }
        function closeModal() {
            const m = document.getElementById('modalSuccess');
            const c = document.getElementById('modalContent');
            c.classList.add('scale-90', 'opacity-0');
            setTimeout(() => { m.classList.add('hidden'); changeView('home'); }, 300);
        }

        startApp();
    </script>
</body>
</html>